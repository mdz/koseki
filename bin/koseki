#!/usr/bin/env ruby

$:.unshift(File.expand_path(File.join(File.dirname(File.dirname($0)), "lib")))

require "irb"
require "irb/completion"

require 'fog'
require 'sequel'
require 'amazon-pricing'
require 'koseki/autoload'

class Controller
  def initialize
    @db = Sequel.connect(ENV['DATABASE_URL'])
    @regions = nil
  end

  def poll_all_clouds
    for cloud in clouds
      poll_cloud(cloud)
    end
  end

  def clouds
    Koseki::Cloud.all
  end

  def poll_cloud(cloud)
    puts "cloud=#{cloud.name} at=starting"

    # Connect to the default region and get the list of available regions
    if @regions == nil
      @regions = Fog::Compute.new({:provider => 'AWS',
            :aws_access_key_id => cloud.access_key_id,
            :aws_secret_access_key => cloud.secret_access_key})
            .describe_regions.body["regionInfo"].map {|region| region["regionName"]}
    end

    for region in @regions
      puts "cloud=#{cloud.name} region=#{region} at=starting"

      cloud.discover_availability_zones(region)

      compute = Fog::Compute.new({:provider => 'AWS',
        :region => region,
        :aws_access_key_id => cloud.access_key_id,
        :aws_secret_access_key => cloud.secret_access_key
      })

      num_reservations = 0
      new_reservations = 0
      for ri in compute.describe_reserved_instances.body["reservedInstancesSet"]
        Koseki::Reservation.find_or_create(:id => ri["reservedInstancesId"]) do |r|
          r.id = ri["reservedInstancesId"]
          r.cloud_id = cloud.id
          r.availability_zone = ri["availabilityZone"]
          r.instance_type = ri["instanceType"]
          r.instance_count = ri["instanceCount"]
          r.start = ri["start"]
          r.duration_seconds = ri["duration"]
          r.offering_type = ri["offeringType"]
          new_reservations += 1
        end
        num_reservations += 1
      end

      num_instances = 0
      new_instances = 0
      now = Time.now
      for server in compute.servers
        i = Koseki::Instance.find_or_create(:instance_id => server.id) do |i|
          i.cloud_id = cloud.id
          i.instance_id = server.id
          i.availability_zone = server.availability_zone
          i.instance_type = server.flavor_id
          i.created_at = server.created_at
          i.last_seen = now
          new_instances += 1
        end

        if i.last_seen != now
          i.update(:last_seen => now)
        end

        num_instances += 1
      end

      puts "cloud=#{cloud.name} region=#{region} at=finished num_instances=#{num_instances} new_instances=#{new_instances} num_reservations=#{num_reservations} new_reservations=#{new_reservations}"
    end

    puts "cloud=#{cloud.name} at=finished"
  end

  def import_pricelist
    regionmap = {
      "us-east" => "us-east-1",
      "apac-tokyo" => "ap-northeast-1",
      "sa-east-1" => "sa-east-1",
      "apac-sin" => "ap-southeast-1",
      "us-west-2" => "us-west-2",
      "us-west" => "us-west-1",
      "eu-ireland" => "eu-west-1"
    }

    price_list = AwsPricing::PriceList.new

    for region in price_list.regions
      for instance_type in region.ec2_on_demand_instance_types
        @db[:instance_ondemand_pricing].insert(
          :region => regionmap[region.name], :instance_type => instance_type.api_name,
          :price => instance_type.linux_price_per_hour * 1000
        )
      end
    end
  end

  def initdb
    @db.create_table :clouds do
      primary_key :id
      String :name, :unique => true
      String :access_key_id, :null => false
      String :secret_access_key, :null => false
    end

    @db.create_table :availability_zone_mappings do
      foreign_key :cloud_id, :clouds
      String :logical_az, :null => false
      Integer :availability_zone_id, :null => false
      unique ([:cloud_id, :logical_az])
    end

    @db.create_table :availability_zones do
      primary_key :id
      String :name, :unique => true
      String :key, :unique => true
      String :region, :null => false
    end

    @db.create_table :reservations do
      String :id, :unique => true, :null => false
      foreign_key :cloud_id, :clouds
      String :availability_zone, :null => false
      String :instance_type, :null => false
      Integer :instance_count, :null => false
      String :offering_type, :null => false
      DateTime :start, :null => false
      Integer :duration_seconds, :null => false
    end

    @db.create_table :instances do
      primary_key :id
      foreign_key :cloud_id, :clouds
      String :instance_id, :null => false
      DateTime :last_seen, :null => false
      String :availability_zone, :null => false
      String :instance_type, :null => false
      DateTime :created_at, :null => false
    end

    @db.create_table :instance_ondemand_pricing do
      String :instance_type, :null => false
      String :region, :null => false
      Integer :price, :null => false
      unique ([:instance_type, :region])
    end

  end
end

case ARGV.first
when 'console'
  controller = Controller.new
  ARGV.clear
  IRB.start
when 'poll'
  Controller.new.poll_all_clouds
when 'get-prices'
  Controller.new.import_pricelist
when 'initdb'
  Controller.new.initdb
else
  raise "Unknown command"
end
